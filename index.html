<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=.0">
    <title>Visor IFC 3D</title>
    <link rel="icon" href="data:,">
    <style>
        *{box-sizing:border-box}body{margin:0;padding:20px;font-family:Segoe UI,sans-serif;background:#f5f7fa;color:#2c3e50;min-height:100vh}
        h1,p{text-align:center;color:#1a3d7c;margin:0 auto 20px;font-size:1.8em;max-width:800px}
        .file-upload{text-align:center;margin:25px 0}
        input[type=file]{padding:12px;border:2px dashed #1a3d7c;border-radius:10px;background:#fff;cursor:pointer;width:100%;max-width:400px}
        #viewer-container{position:relative;width:90vw;max-width:1200px;height:70vh;min-height:500px;margin:30px auto;border:1px solid #ddd;border-radius:16px;overflow:hidden;background:#fff;box-shadow:0 15px 35px rgba(0,0,0,.18)}
        .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.9);padding:15px 25px;border-radius:8px;color:#1a3d7c;font-weight:600}
        @media(max-width:768px){#viewer-container{width:95vw;height:60vh;min-height:400px}h1{font-size:1.5em}}
    </style>
</head>
<body>
    <h1>Visor IFC 3D</h1>
    <p>Sube tu IFC o usa el ejemplo</p>
    <div class="file-upload">
        <input type="file" id="file-input" accept=".ifc">
    </div>
    <div id="viewer-container"><div class="loading">Cargando...</div></div>

    <script type="importmap">
    {"imports":{"three":"https://unpkg.com/three@0.160.0/build/three.module.js","three/addons/":"https://unpkg.com/three@0.160.0/examples/jsm/"}}
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        const { IfcAPI, IFCMESH } = await import('https://cdn.jsdelivr.net/npm/web-ifc@0.0.51/web-ifc-api.js');

        const container = document.getElementById('viewer-container');
        const input = document.getElementById('file-input');
        const loading = container.querySelector('.loading');

        const viewer = new class {
            constructor() {
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0xf5f7fa);
                this.camera = new THREE.PerspectiveCamera(75, container.clientWidth/container.clientHeight, 0.1, 1000);
                this.camera.position.set(10,10,10);
                this.renderer = new THREE.WebGLRenderer({antialias:true});
                this.renderer.setSize(container.clientWidth, container.clientHeight);
                this.renderer.shadowMap.enabled = true;
                container.appendChild(this.renderer.domElement);
                const ctrl = new OrbitControls(this.camera, this.renderer.domElement);
                ctrl.enableDamping = true;
                const animate = () => { requestAnimationFrame(animate); ctrl.update(); this.renderer.render(this.scene, this.camera); };
                animate();

                this.ifc = new IfcAPI();
                this.ifc.SetWasmPath('https://cdn.jsdelivr.net/npm/web-ifc@0.0.51/');
                this.models = [];
            }
            async load(url) {
                loading.style.display = 'block';
                this.models.forEach(m=>m&&this.scene.remove(m));
                this.models = [];
                await this.ifc.Init();
                const data = await fetch(url);
                if(!data.ok) throw new Error('No IFC');
                const buf = await data.arrayBuffer();
                const id = this.ifc.OpenModel(new Uint8Array(buf));
                const mesh = await this.buildMesh(id);
                this.scene.add(mesh);
                this.models.push(mesh);
                this.fit(mesh);
                loading.style.display = 'none';
            }
            async buildMesh(id) {
                const geom = new THREE.BufferGeometry();
                const pos = [], idx = [];
                const lines = this.ifc.GetLineIDsWithType(id, IFCMESH);
                for(let i=0;i<lines.size();i++){
                    const line = lines.get(i);
                    const g = this.ifc.GetGeometry(id, line);
                    if(!g) continue;
                    const v = g.GetVertexData(), ind = g.GetIndexData();
                    const base = pos.length/3;
                    for(let j=0;j<v.length;j+=3) pos.push(v[j],v[j+1],v[j+2]);
                    for(let j=0;j<ind.length;j++) idx.push(ind[j]+base);
                }
                if(pos.length===0) throw new Error('No geom');
                geom.setAttribute('position', new THREE.Float32BufferAttribute(pos,3));
                geom.setIndex(idx);
                geom.computeVertexNormals();
                return new THREE.Mesh(geom, new THREE.MeshLambertMaterial({color:0x6699ff,side:THREE.DoubleSide}));
            }
            fit(obj){
                const box = new THREE.Box3().setFromObject(obj);
                const c = box.getCenter(new THREE.Vector3());
                const s = box.getSize(new THREE.Vector3());
                const max = Math.max(s.x,s.y,s.z);
                const fov = this.camera.fov * Math.PI/180;
                let z = max/2/Math.tan(fov/2)*1.5;
                this.camera.position.copy(c).add(new THREE.Vector3(z,z,z).normalize().multiplyScalar(z));
                this.camera.lookAt(c);
            }
        };

        // Modelo de ejemplo con CORS y 200 OK
        const SAMPLE = 'https://raw.githubusercontent.com/IFCjs/test-ifc-files/main/01.ifc';
        viewer.load(SAMPLE).catch(() => {
            loading.textContent = 'Ejemplo no disponible. Sube tu IFC.';
        });

        input.onchange = e => {
            const f = e.target.files[0];
            if(!f) return;
            const url = URL.createObjectURL(f);
            viewer.load(url).catch(() => {
                loading.textContent = 'IFC inv√°lido';
                loading.style.color = '#e74c3c';
            });
        };
    </script>
</body>
</html>
